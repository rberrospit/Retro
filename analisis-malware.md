## ANÁLISIS DE MALWARE R2D2

Descargar la imagen forense `0zapftis.vmem` desde https://drive.google.com/file/d/1Jz0SQnIqpRcb-koVeCvJJ5LuKBFXFiEH/view?usp=sharing

**Determinar el profile**

Para determinar el profile (Sistema operativo y su versión) es necesario conocer sobre que profile se realizará la inspección, por ello ejecutar lo siguiente:

```
./volatility -f images/0zapftis.vmem imageinfo
```
![image](https://user-images.githubusercontent.com/50930193/142275284-1bb6b2aa-9186-460d-ad45-ad9282da4b37.png)

Esta imagen de memoria es ejecutada sobre un sistema de 32 bits de Windows XP Con Service Pack 2. El equipo tiene un procesador basado en PAE (Physical Address Extension). La imagen fue adquirida el 10 de octubre del 2011.

 
**Listar los Procesos**
 

Conocido el profile, para listar los procesos en memoria abrir el terminal y ejecutar lo siguiente:
```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 pslist
```

![image](https://user-images.githubusercontent.com/50930193/142275850-a36c31b9-eedc-4cd4-a4d0-bfb10a1a45c6.png)

**Listar Árbol de Procesos**

Y si se desea saber el árbol de proceso ejecutar lo siguiente:
```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 pstree
```
![image](https://user-images.githubusercontent.com/50930193/142275954-080f55df-3fa8-4281-a5a6-3d598c494457.png)


Visualizando la lista, pareciera que ningún proceso está funcionando fuera de lo común.

Con el plugin **psscan**, hace uso del direccionamiento de memoria física con el beneficio del uso de psscan es que algunas veces muestra información de procesos que no aparecen con otros comandos.

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 psscan
```
![image](https://user-images.githubusercontent.com/50930193/142276318-61658268-20f5-4c84-b0ec-54fcb3912d3a.png)

Otro plugin útil es **psxview** el cual permite encontrar y detectar procesos de ejecución oculta se hace uso del código

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 psxview
```
![image](https://user-images.githubusercontent.com/50930193/142276850-2e3c5472-a867-44cb-8d5e-1b729bf49c50.png)

Este último comando permite visualizar una lista más detallada de procesos que corren en una imagen de memoria mediante cinco métodos de detección de procesos ***(pslist, psscan, thrdproc, pspcdid y csrss)***. 
Para que un proceso sea considerado oculto, debe ser invisible para cualquier método de detección sin considerar el csrss. De la pantalla, basado en la lista, 
en todos los métodos de pslist, psscan, thrproc y pspcid aparecen como True, por lo que no se encontraron procesos ocultos.
Con los comandos usados no se han encontrado indicadores que comprometan el sistema por el momento.

Ahora, se hará uso de comandos que revelará información sobre comandos escritos sobre una **Shell**. 
Los comandos **cmdscan** y **consoles** permite consultar la memoria del proceso csrss.exe o conhost.exe 
para verificar comandos introducidos desde la Shell del sistema o a través de una sesión por backdoor de un atacante.

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 cmdscan
```
![image](https://user-images.githubusercontent.com/50930193/142277380-ba7f1675-250c-488d-b511-c97e5f86109c.png)

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 consoles
```
![image](https://user-images.githubusercontent.com/50930193/142283578-b07a9e72-7a0a-4ff2-9f38-abec5fc0ef03.png)

Como se puede verificar dentro de los cuadros rojos de ambas capturas de pantalla, de manera local o remotamente se realizó la consulta por un servicio denominado malware. Con la última consulta de sc query malware y se halló que era un controlador basado en Kernel.

**Visualizar conexiones**

Para visualizar las conexión TCP que estuvieron activas en el momento de la adquisición de la memoria, utilizar el comando “connections”.

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 connscan
```

![image](https://user-images.githubusercontent.com/50930193/142280965-d25a0c7f-f776-4323-8851-cd39059adb46.png)


El PID 1956, según la imagen 2 el proceso **explorer.exe**, estableció una conexión con el sistema remoto 172.16.98.1 haciendo uso del puerto 6666. 


![image](https://user-images.githubusercontent.com/50930193/142282139-2c4afd48-9b69-4e9f-bc2d-7ef15dcc8c31.png)

Buscando dicho IPS por Whois se puede observar que la IP pertenece a una red privada ubicada en estados unidos.


Ahora, revisemos los sockets de escucha para algún protocolo (TCP, UDP, RAW, ETC)

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 sockets -P
```
![image](https://user-images.githubusercontent.com/50930193/142282482-e6f742b8-22e1-4fda-9495-0a4054f1eccd.png)
 
Para poder encontrar controladores específicos que aluden los comandos cmdscan y consolas, se hace uso de los plugin **driverscan** y **driverirp**

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 driverscan
```
Richirey100@oscp
![image](https://user-images.githubusercontent.com/50930193/142284510-e62d7d43-868c-44c9-a8d9-c3a728ea11b6.png)

![image](https://user-images.githubusercontent.com/50930193/142284812-3877294f-0a56-4be5-aeb7-23e99e8fa8d4.png)

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 driverirp
```
![image](https://user-images.githubusercontent.com/50930193/142285557-a78901ba-fc24-4248-9a70-4eec4145c6ee.png)

Como se puede observar en las imagenes anteriores, el controlador **winsys3**2 está asociado al controlador denominado **malware**. Para poder volcar los controladores de memoria, se hace uso del comando **moddump**. Para eso se debe especificar el desplazamiento de memoria y hacer uso del inicio de memoria del controlador a analizar. Y como se verifica en la imagen 10 y 11, la dirección de memoria empieza en **0xf9eb4000**.

```
./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 moddump -b 0xf9eb4000 --dump-dir DUMP/

ó

./volatility -f images/0zapftis.vmem --profile=WinXPSP2x86 moddump -b 0xf9eb4000 -D DUMP/
```

![image](https://user-images.githubusercontent.com/50930193/142286360-ed0444ea-e23b-41be-8214-83607d167b80.png)


 
Cargue el archivo dumpeado a virtustotal [Virus Total](https://www.virustotal.com). Analizando el dump realizado al controlador winsys32.sys por medio de virustotal, se halla que 46 de 61 antivirus lo detecta como un virus troyano R2D2.

![image](https://user-images.githubusercontent.com/50930193/142322464-1ceaf3e4-d7c2-4068-b638-4b6d2c055578.png)
